@inherits BunitContext

@using BitBlazor.Form.Toggle
@using System.ComponentModel.DataAnnotations

@code {
    [Fact]
    public void BitToggle_Should_Render_Default_Markup_Correctly()
    {
        bool value = false;

        var component = Render(
            @<BitToggle Label="label"
                        Id="test-toggle"
                        @bind-Value="value"/>);

        component.MarkupMatches(
            @<div class="form-check form-check-inline">
                <div class="toggles">
                    <label for="test-toggle">
                        label
                        <input id="test-toggle" name="test-toggle" class="" type="checkbox" value="True" />
                        <span class="lever"></span>
                    </label>
                </div>
             </div>);
    }

    [Fact]
    public void BitToggle_Should_Render_Disabled_Toggle_Correctly()
    {
        bool value = false;

        var component = Render(
            @<BitToggle Label="label"
                        Id="test-toggle"
                        @bind-Value="value"
                        Disabled="true"/>);

        component.MarkupMatches(
            @<div class="form-check form-check-inline">
                <div class="toggles">
                    <label for="test-toggle">
                        label
                        <input id="test-toggle" name="test-toggle" class="" type="checkbox" value="True" disabled />
                        <span class="lever"></span>
                    </label>
                </div>
             </div>);
    }

    [Fact]
    public void BitToggle_Should_Render_Inline_Toggle_If_ViewMode_Is_Specified_As_Inline()
    {
        bool value = false;

        var component = Render(
            @<BitToggle Label="label"
                        Id="test-toggle"
                        ViewMode="ToggleViewMode.Inline"
                        @bind-Value="value"/>);

        component.MarkupMatches(
            @<div class="form-check form-check-inline">
                <div class="toggles">
                    <label for="test-toggle">
                        label
                        <input id="test-toggle" name="test-toggle" class="" type="checkbox" value="True" />
                        <span class="lever"></span>
                    </label>
                </div>
             </div>);
    }

    [Fact]
    public void BitToggle_Should_Render_Grouped_Toggle_If_ViewMode_Is_Specified_As_Grouped()
    {
        bool value = false;

        var component = Render(
            @<BitToggle Label="label"
                        Id="test-toggle"
                        ViewMode="ToggleViewMode.Grouped"
                        @bind-Value="value"/>);

        component.MarkupMatches(
            @<div class="form-check form-check-group">
                <div class="toggles">
                    <label for="test-toggle">
                        label
                        <input id="test-toggle" name="test-toggle" class="" type="checkbox" value="True" />
                        <span class="lever"></span>
                    </label>
                </div>
             </div>);
    }

    [Fact]
    public void BitToggle_Should_Render_Additional_Text_Correctly()
    {
        bool value = false;

        var component = Render(
            @<BitToggle Label="label"
                        Id="test-toggle"
                        @bind-Value="value"
                        AdditionalTextId="helper-text">
                <AdditionalText>this is a help text</AdditionalText>
            </BitToggle>);

        component.MarkupMatches(
            @<div class="form-check form-check-inline">
                <div class="toggles">
                    <label for="test-toggle">
                        label
                        <input id="test-toggle" name="test-toggle" class="" type="checkbox" value="True" aria-describedby="helper-text" />
                        <span class="lever"></span>
                    </label>
                </div>
                <small id="helper-text" class="form-text">this is a help text</small>
             </div>);
    }

    [Fact]
    public void BitToggle_Should_Add_Checked_Attribute_If_Bind_Value_Is_True()
    {
        bool value = true;

        var component = Render(
            @<BitToggle Label="label"
                        Id="test-toggle"
                        @bind-Value="value"/>);

        component.MarkupMatches(
            @<div class="form-check form-check-inline">
                <div class="toggles">
                    <label for="test-toggle">
                        label
                        <input id="test-toggle" name="test-toggle" class="" type="checkbox" checked value="True" />
                        <span class="lever"></span>
                    </label>
                </div>
             </div>);
    }

    [Fact]
    public void BitToggle_Should_Show_Invalid_Class_When_Field_Has_Validation_Error()
    {
        var model = new ToggleValidationModel();
        var editContext = new EditContext(model);
        var submitted = false;

        var component = Render(
            @<EditForm EditContext="@editContext" OnValidSubmit="() => submitted = true">
                <DataAnnotationsValidator />
                <BitToggle Label="Enable Option"
                           Id="test-enabled"
                           @bind-Value="@model.IsEnabled"
                           For="@(() => model.IsEnabled)" />
                <button type="submit" id="submit-btn">Submit</button>
             </EditForm>);

        // Trigger validation by submitting the form
        var form = component.Find("form");
        form.Submit();

        var input = component.Find("input#test-enabled");
        Assert.Contains("is-invalid", input.ClassList);
        Assert.DoesNotContain("just-validate-success-field", input.ClassList);
        Assert.False(submitted);
    }

    [Fact]
    public void BitToggle_Should_Show_Success_Class_When_Valid_Field_Is_Modified()
    {
        var model = new ToggleValidationModel { IsEnabled = true };
        var editContext = new EditContext(model);
        var submitted = false;

        var component = Render(
            @<EditForm EditContext="@editContext" OnValidSubmit="() => submitted = true">
                <DataAnnotationsValidator />
                <BitToggle Label="Enable Option"
                           Id="test-enabled"
                           @bind-Value="@model.IsEnabled"
                           For="@(() => model.IsEnabled)" />
                <button type="submit" id="submit-btn">Submit</button>
             </EditForm>);

        // Trigger validation by submitting the form
        var form = component.Find("form");
        form.Submit();

        var input = component.Find("input#test-enabled");
        Assert.Contains("just-validate-success-field", input.ClassList);
        Assert.DoesNotContain("is-invalid", input.ClassList);
        Assert.True(submitted);
    }

    [Fact]
    public void BitToggle_Should_Render_Validation_Message_With_Correct_Class()
    {
        var model = new ToggleValidationModel();
        var editContext = new EditContext(model);

        var component = Render(
            @<EditForm EditContext="@editContext" OnValidSubmit="() => {}">
                <DataAnnotationsValidator />
                <BitToggle Label="Enable Option"
                           Id="test-enabled"
                           @bind-Value="@model.IsEnabled"
                           For="@(() => model.IsEnabled)" />
                <button type="submit" id="submit-btn">Submit</button>
             </EditForm>);

        // Trigger validation by submitting the form
        var form = component.Find("form");
        form.Submit();

        var validationMessage = component.Find(".just-validate-error-label");
        Assert.NotNull(validationMessage);
        Assert.Contains("You must enable this option", validationMessage.TextContent);
    }

    [Fact]
    public void BitToggle_Should_Not_Show_Validation_Classes_When_Field_Not_Modified()
    {
        var model = new ToggleValidationModel();
        var editContext = new EditContext(model);

        var component = Render(
            @<EditForm EditContext="@editContext" OnValidSubmit="() => {}">
                <DataAnnotationsValidator />
                <BitToggle Label="Enable Option"
                           Id="test-enabled"
                           @bind-Value="@model.IsEnabled"
                           For="@(() => model.IsEnabled)" />
                <button type="submit" id="submit-btn">Submit</button>
             </EditForm>);

        // Do NOT submit the form - field is pristine
        var input = component.Find("input#test-enabled");
        Assert.DoesNotContain("is-invalid", input.ClassList);
        Assert.DoesNotContain("just-validate-success-field", input.ClassList);
    }

    // Nested test model for validation tests
    public class ToggleValidationModel
    {
        [Range(typeof(bool), "true", "true", ErrorMessage = "You must enable this option")]
        public bool IsEnabled { get; set; }
    }
}
