@inherits BunitContext
@using System.ComponentModel.DataAnnotations

@code {
    [Fact]
    public void BitPasswordField_Should_Render_Default_Component_Correctly()
    {
        string? value = null;

        var component = Render(
            @<BitPasswordField Label="label"
                               Id="test-passwordfield"
                               @bind-Value="value"/>);

        component.MarkupMatches(
            @<div class="form-group">
                <label class="" for="test-passwordfield">label</label>
                <input type="password" class="form-control input-password" id="test-passwordfield" name="test-passwordfield" />
                <button type="button" class="password-icon btn" role="switch" aria-checked="false">
                    <span class="visually-hidden">show/hide password</span>
                    <svg class="password-icon-visible icon icon-sm" aria-hidden="true"><use href="/_content/BitBlazor/bootstrap-italia/svg/sprites.svg#it-password-visible"></use></svg>
                    <svg class="password-icon-invisible icon icon-sm d-none" aria-hidden="true"><use href="/_content/BitBlazor/bootstrap-italia/svg/sprites.svg#it-password-invisible"></use></svg>
                </button>
             </div>);
    }

    [Fact]
    public void BitPasswordField_Should_Render_Additional_Text_Correctly()
    {
        string? value = null;

        var component = Render(
            @<BitPasswordField Label="label"
                               Id="test-passwordfield"
                               @bind-Value="value"
                               AdditionalTextId="passwordInfo">
                <AdditionalText>
                    type at least 8 characters
                </AdditionalText>
             </BitPasswordField>);

        component.MarkupMatches(
            @<div class="form-group">
                <label class="" for="test-passwordfield">label</label>
                <input type="password" class="form-control input-password" id="test-passwordfield" name="test-passwordfield" aria-describedby="passwordInfo" />
                <button type="button" class="password-icon btn" role="switch" aria-checked="false">
                    <span class="visually-hidden">show/hide password</span>
                    <svg class="password-icon-visible icon icon-sm" aria-hidden="true"><use href="/_content/BitBlazor/bootstrap-italia/svg/sprites.svg#it-password-visible"></use></svg>
                    <svg class="password-icon-invisible icon icon-sm d-none" aria-hidden="true"><use href="/_content/BitBlazor/bootstrap-italia/svg/sprites.svg#it-password-invisible"></use></svg>
                </button>
                <p id="passwordInfo" class="form-text text-muted d-block small pb-0">type at least 8 characters</p>
             </div>);
    }

    [Fact]
    public void BitPasswordField_Should_Show_Invalid_Class_When_Field_Has_Validation_Error()
    {
        var model = new PasswordValidationModel();
        var editContext = new EditContext(model);
        var submitted = false;

        var component = Render(
            @<EditForm EditContext="@editContext" OnValidSubmit="() => submitted = true">
                <DataAnnotationsValidator />
                <BitPasswordField Label="Password"
                                  Id="test-password"
                                  @bind-Value="@model.Password"
                                  For="@(() => model.Password)" />
                <button type="submit" id="submit-btn">Submit</button>
             </EditForm>);

        // Trigger validation by submitting the form
        var submitButton = component.Find("#submit-btn");
        submitButton.Click();

        var input = component.Find("input#test-password");
        Assert.Contains("is-invalid", input.ClassList);
        Assert.DoesNotContain("just-validate-success-field", input.ClassList);
        Assert.False(submitted);
    }

    [Fact]
    public void BitPasswordField_Should_Show_Success_Class_When_Valid_Field_Is_Modified()
    {
        var model = new PasswordValidationModel { Password = "ValidPass123" };
        var editContext = new EditContext(model);
        var submitted = false;

        var component = Render(
            @<EditForm EditContext="@editContext" OnValidSubmit="() => submitted = true">
                <DataAnnotationsValidator />
                <BitPasswordField Label="Password"
                                  Id="test-password"
                                  @bind-Value="@model.Password"
                                  For="@(() => model.Password)" />
                <button type="submit" id="submit-btn">Submit</button>
             </EditForm>);

        // Trigger validation by submitting the form
        var submitButton = component.Find("#submit-btn");
        submitButton.Click();

        var input = component.Find("input#test-password");
        Assert.Contains("just-validate-success-field", input.ClassList);
        Assert.DoesNotContain("is-invalid", input.ClassList);
        Assert.True(submitted);
    }

    [Fact]
    public void BitPasswordField_Should_Render_Validation_Message_With_Correct_Class()
    {
        var model = new PasswordValidationModel();
        var editContext = new EditContext(model);

        var component = Render(
            @<EditForm EditContext="@editContext" OnValidSubmit="() => {}">
                <DataAnnotationsValidator />
                <BitPasswordField Label="Password"
                                  Id="test-password"
                                  @bind-Value="@model.Password"
                                  For="@(() => model.Password)" />
                <button type="submit" id="submit-btn">Submit</button>
             </EditForm>);

        // Trigger validation by submitting the form
        var submitButton = component.Find("#submit-btn");
        submitButton.Click();

        var validationMessage = component.Find(".just-validate-error-label");
        Assert.NotNull(validationMessage);
        Assert.Contains("Password is required", validationMessage.TextContent);
    }

    [Fact]
    public void BitPasswordField_Should_Not_Show_Validation_Classes_When_Field_Not_Modified()
    {
        var model = new PasswordValidationModel();
        var editContext = new EditContext(model);

        var component = Render(
            @<EditForm EditContext="@editContext" OnValidSubmit="() => {}">
                <DataAnnotationsValidator />
                <BitPasswordField Label="Password"
                                  Id="test-password"
                                  @bind-Value="@model.Password"
                                  For="@(() => model.Password)" />
                <button type="submit" id="submit-btn">Submit</button>
             </EditForm>);

        // Do NOT submit the form - field is pristine
        var input = component.Find("input#test-password");
        Assert.DoesNotContain("is-invalid", input.ClassList);
        Assert.DoesNotContain("just-validate-success-field", input.ClassList);
    }

    // Nested test model for validation tests
    public class PasswordValidationModel
    {
        [Required(ErrorMessage = "Password is required")]
        [MinLength(8, ErrorMessage = "Password must be at least 8 characters")]
        public string? Password { get; set; }
    }
}
