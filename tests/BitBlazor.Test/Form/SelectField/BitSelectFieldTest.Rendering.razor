@inherits BunitContext
@using System.ComponentModel.DataAnnotations

@code {
    [Fact]
    public void BitSelectField_Should_Render_Default_Markup_Correctly()
    {
        string value = string.Empty;

        var component = Render(
            @<BitSelectField Label="label" 
                             Id="test-selectfield"
                             @bind-Value="value">
                <BitSelectItem TValue="string" Value="@string.Empty">Choose your option</BitSelectItem>
                <BitSelectItem TValue="string" Value="@("value 1")">value 1</BitSelectItem>
                <BitSelectItem TValue="string" Value="@("value 2")">value 2</BitSelectItem>
             </BitSelectField>);

        component.MarkupMatches(
            @<div class="select-wrapper">
                <label for="test-selectfield">label</label>
                <select id="test-selectfield" name="test-selectfield" value="" class="">
                    <option selected value="">Choose your option</option>
                    <option value="value 1">value 1</option>
                    <option value="value 2">value 2</option>
                </select>
             </div>);
    }

    [Fact]
    public void BitSelectField_Should_Render_Disabled_Select_Correctly()
    {
        string value = string.Empty;

        var component = Render(
            @<BitSelectField Label="label" 
                             Id="test-selectfield"
                             @bind-Value="value"
                             Disabled="true">
                <BitSelectItem TValue="string" Value="@string.Empty">Choose your option</BitSelectItem>
                <BitSelectItem TValue="string" Value="@("value 1")">value 1</BitSelectItem>
                <BitSelectItem TValue="string" Value="@("value 2")">value 2</BitSelectItem>
             </BitSelectField>);

        component.MarkupMatches(
            @<div class="select-wrapper">
                <label for="test-selectfield">label</label>
                <select id="test-selectfield" name="test-selectfield" value="" class="" disabled>
                    <option selected value="">Choose your option</option>
                    <option value="value 1">value 1</option>
                    <option value="value 2">value 2</option>
                </select>
             </div>);
    }

    [Fact]
    public void BitSelectField_Should_Render_Option_Group_Correctly()
    {
        string value = string.Empty;

        var component = Render(
            @<BitSelectField Label="label" 
                             Id="test-selectfield"
                             @bind-Value="value">
                <BitSelectItem TValue="string" Value="@string.Empty">Choose your option</BitSelectItem>
                <BitSelectItemGroup Label="Group 1">
                    <BitSelectItem TValue="string" Value="@("value 1")">value 1</BitSelectItem>
                    <BitSelectItem TValue="string" Value="@("value 2")">value 2</BitSelectItem>
                </BitSelectItemGroup>
                <BitSelectItemGroup Label="Group 2">
                    <BitSelectItem TValue="string" Value="@("value 3")">value 3</BitSelectItem>
                    <BitSelectItem TValue="string" Value="@("value 4")">value 4</BitSelectItem>
                </BitSelectItemGroup>
             </BitSelectField>);

        component.MarkupMatches(
            @<div class="select-wrapper">
                <label for="test-selectfield">label</label>
                <select id="test-selectfield" name="test-selectfield" value="" class="">
                    <option selected value="">Choose your option</option>
                    <optgroup label="Group 1">
                        <option value="value 1">value 1</option>
                        <option value="value 2">value 2</option>
                    </optgroup>
                    <optgroup label="Group 2">
                        <option value="value 3">value 3</option>
                        <option value="value 4">value 4</option>
                    </optgroup>
                </select>
             </div>);
    }

    [Fact]
    public void BitSelectField_Should_Render_Additional_Text_Correctly()
    {
        string value = string.Empty;

        var component = Render(
            @<BitSelectField Label="label" 
                             Id="test-selectfield"
                             @bind-Value="value"
                             AdditionalTextId="help-text">
                 <ChildContent>
                     <BitSelectItem TValue="string" Value="@string.Empty">Choose your option</BitSelectItem>
                     <BitSelectItemGroup Label="Group 1">
                         <BitSelectItem TValue="string" Value="@("value 1")">value 1</BitSelectItem>
                         <BitSelectItem TValue="string" Value="@("value 2")">value 2</BitSelectItem>
                     </BitSelectItemGroup>
                     <BitSelectItemGroup Label="Group 2">
                         <BitSelectItem TValue="string" Value="@("value 3")">value 3</BitSelectItem>
                         <BitSelectItem TValue="string" Value="@("value 4")">value 4</BitSelectItem>
                     </BitSelectItemGroup>
                 </ChildContent>
                <AdditionalText>
                    This is a help text
                </AdditionalText>
             </BitSelectField>);

        component.MarkupMatches(
            @<div class="select-wrapper">
                <label for="test-selectfield">label</label>
                <select id="test-selectfield" name="test-selectfield" value="" class="" aria-describedby="help-text">
                    <option selected value="">Choose your option</option>
                    <optgroup label="Group 1">
                        <option value="value 1">value 1</option>
                        <option value="value 2">value 2</option>
                    </optgroup>
                    <optgroup label="Group 2">
                        <option value="value 3">value 3</option>
                        <option value="value 4">value 4</option>
                    </optgroup>
                </select>
                <small id="help-text" class="form-text">This is a help text</small>
             </div>);
    }

    [Fact]
    public void BitSelectField_Should_Render_Option_As_Disabled_If_Option_Disabled_Property_Is_Set_To_True()
    {
        string value = string.Empty;

        var component = Render(
            @<BitSelectField Label="label" 
                             Id="test-selectfield"
                             @bind-Value="value">
                <BitSelectItem TValue="string" Value="@string.Empty">Choose your option</BitSelectItem>
                <BitSelectItem TValue="string" Value="@("value 1")" Disabled="true">value 1</BitSelectItem>
                <BitSelectItem TValue="string" Value="@("value 2")">value 2</BitSelectItem>
             </BitSelectField>);

        component.MarkupMatches(
            @<div class="select-wrapper">
                <label for="test-selectfield">label</label>
                <select id="test-selectfield" name="test-selectfield" value="" class="">
                    <option selected value="">Choose your option</option>
                    <option value="value 1" disabled>value 1</option>
                    <option value="value 2">value 2</option>
                </select>
             </div>);
    }

    [Fact]
    public void BitSelectField_Should_Render_Option_Group_Disabled_If_Disabled_Property_Is_Set_To_True()
    {
        string value = string.Empty;

        var component = Render(
            @<BitSelectField Label="label" 
                             Id="test-selectfield"
                             @bind-Value="value">
                <BitSelectItem TValue="string" Value="@string.Empty">Choose your option</BitSelectItem>
                <BitSelectItemGroup Label="Group 1" Disabled="true">
                    <BitSelectItem TValue="string" Value="@("value 1")">value 1</BitSelectItem>
                    <BitSelectItem TValue="string" Value="@("value 2")">value 2</BitSelectItem>
                </BitSelectItemGroup>
                <BitSelectItemGroup Label="Group 2">
                    <BitSelectItem TValue="string" Value="@("value 3")">value 3</BitSelectItem>
                    <BitSelectItem TValue="string" Value="@("value 4")">value 4</BitSelectItem>
                </BitSelectItemGroup>
             </BitSelectField>);

        component.MarkupMatches(
            @<div class="select-wrapper">
                <label for="test-selectfield">label</label>
                <select id="test-selectfield" name="test-selectfield" value="" class="">
                    <option selected value="">Choose your option</option>
                    <optgroup label="Group 1" disabled>
                        <option value="value 1">value 1</option>
                        <option value="value 2">value 2</option>
                    </optgroup>
                    <optgroup label="Group 2">
                        <option value="value 3">value 3</option>
                        <option value="value 4">value 4</option>
                    </optgroup>
                </select>
             </div>);
    }

    [Fact]
    public void BitSelectField_Should_Show_Invalid_Class_When_Field_Has_Validation_Error()
    {
        var model = new SelectValidationModel();
        var editContext = new EditContext(model);
        var submitted = false;

        var component = Render(
            @<EditForm EditContext="@editContext" OnValidSubmit="() => submitted = true">
                <DataAnnotationsValidator />
                <BitSelectField Label="Country"
                                Id="test-country"
                                @bind-Value="@model.Country"
                                For="@(() => model.Country)">
                    <BitSelectItem TValue="string?" Value="@((string?)null)">Choose a country</BitSelectItem>
                    <BitSelectItem TValue="string?" Value="@("USA")">USA</BitSelectItem>
                    <BitSelectItem TValue="string?" Value="@("UK")">UK</BitSelectItem>
                </BitSelectField>
                <button type="submit" id="submit-btn">Submit</button>
             </EditForm>);

        // Trigger validation by submitting the form
        var form = component.Find("form");
        form.Submit();

        var select = component.Find("select#test-country");
        Assert.Contains("is-invalid", select.ClassList);
        Assert.DoesNotContain("just-validate-success-field", select.ClassList);
        Assert.False(submitted);
    }

    [Fact]
    public void BitSelectField_Should_Show_Success_Class_When_Valid_Field_Is_Modified()
    {
        var model = new SelectValidationModel { Country = "USA" };
        var editContext = new EditContext(model);
        var submitted = false;

        var component = Render(
            @<EditForm EditContext="@editContext" OnValidSubmit="() => submitted = true">
                <DataAnnotationsValidator />
                <BitSelectField Label="Country"
                                Id="test-country"
                                @bind-Value="@model.Country"
                                For="@(() => model.Country)">
                    <BitSelectItem TValue="string?" Value="@((string?)null)">Choose a country</BitSelectItem>
                    <BitSelectItem TValue="string?" Value="@("USA")">USA</BitSelectItem>
                    <BitSelectItem TValue="string?" Value="@("UK")">UK</BitSelectItem>
                </BitSelectField>
                <button type="submit" id="submit-btn">Submit</button>
             </EditForm>);

        // Trigger validation by submitting the form
        var form = component.Find("form");
        form.Submit();

        var select = component.Find("select#test-country");
        Assert.Contains("just-validate-success-field", select.ClassList);
        Assert.DoesNotContain("is-invalid", select.ClassList);
        Assert.True(submitted);
    }

    [Fact]
    public void BitSelectField_Should_Render_Validation_Message_With_Correct_Class()
    {
        var model = new SelectValidationModel();
        var editContext = new EditContext(model);

        var component = Render(
            @<EditForm EditContext="@editContext" OnValidSubmit="() => {}">
                <DataAnnotationsValidator />
                <BitSelectField Label="Country"
                                Id="test-country"
                                @bind-Value="@model.Country"
                                For="@(() => model.Country)">
                    <BitSelectItem TValue="string?" Value="@((string?)null)">Choose a country</BitSelectItem>
                    <BitSelectItem TValue="string?" Value="@("USA")">USA</BitSelectItem>
                    <BitSelectItem TValue="string?" Value="@("UK")">UK</BitSelectItem>
                </BitSelectField>
                <button type="submit" id="submit-btn">Submit</button>
             </EditForm>);

        // Trigger validation by submitting the form
        var form = component.Find("form");
        form.Submit();

        var validationMessage = component.Find(".just-validate-error-label");
        Assert.NotNull(validationMessage);
        Assert.Contains("Country is required", validationMessage.TextContent);
    }

    [Fact]
    public void BitSelectField_Should_Not_Show_Validation_Classes_When_Field_Not_Modified()
    {
        var model = new SelectValidationModel();
        var editContext = new EditContext(model);

        var component = Render(
            @<EditForm EditContext="@editContext" OnValidSubmit="() => {}">
                <DataAnnotationsValidator />
                <BitSelectField Label="Country"
                                Id="test-country"
                                @bind-Value="@model.Country"
                                For="@(() => model.Country)">
                    <BitSelectItem TValue="string?" Value="@((string?)null)">Choose a country</BitSelectItem>
                    <BitSelectItem TValue="string?" Value="@("USA")">USA</BitSelectItem>
                    <BitSelectItem TValue="string?" Value="@("UK")">UK</BitSelectItem>
                </BitSelectField>
                <button type="submit" id="submit-btn">Submit</button>
             </EditForm>);

        // Do NOT submit the form - field is pristine
        var select = component.Find("select#test-country");
        Assert.DoesNotContain("is-invalid", select.ClassList);
        Assert.DoesNotContain("just-validate-success-field", select.ClassList);
    }

    // Nested test model for validation tests
    public class SelectValidationModel
    {
        [Required(ErrorMessage = "Country is required")]
        public string? Country { get; set; }
    }
}
