@inherits BunitContext
@using System.ComponentModel.DataAnnotations

@code {
    [Fact]
    public void BitCheckbox_Should_Render_Default_Markup_Correctly()
    {
        bool value = false;

        var component = Render(
            @<BitCheckbox Label="label"
                          Id="test-checkbox"
                          @bind-Value="value" />);

        component.MarkupMatches(
            @<div class="form-check">
                <input id="test-checkbox" name="test-checkbox" class="" type="checkbox" value="True" />
                <label for="test-checkbox" class="">label</label>
             </div>);
    }

    [Fact]
    public void BitCheckbox_Should_Render_Inline_Class_Correctly()
    {
        bool value = false;

        var component = Render(
            @<BitCheckbox Label="label"
                          Id="test-checkbox"
                          @bind-Value="value"
                          Inline="true"/>);

        component.MarkupMatches(
            @<div class="form-check form-check-inline">
                <input id="test-checkbox" name="test-checkbox" class="" type="checkbox" value="True" />
                <label for="test-checkbox" class="">label</label>
             </div>);
    }

    [Fact]
    public void BitCheckbox_Should_Add_Checked_Attribute_If_Bind_Value_Is_True()
    {
        bool value = true;

        var component = Render(
            @<BitCheckbox Label="label"
                          Id="test-checkbox"
                          @bind-Value="value" />);

        component.MarkupMatches(
            @<div class="form-check">
                <input id="test-checkbox" name="test-checkbox" class="" type="checkbox" checked value="True" />
                <label for="test-checkbox" class="">label</label>
             </div>);
    }

    [Fact]
    public void BitCheckbox_Should_Render_Disabled_Attribute_Correctly_And_Add_Disabled_Class_To_Label_When_Disabled()
    {
        bool value = false;

        var component = Render(
            @<BitCheckbox Label="label"
                          Id="test-checkbox"
                          @bind-Value="value"
                          Disabled="true"/>);

        component.MarkupMatches(
            @<div class="form-check">
                <input id="test-checkbox" name="test-checkbox" class="" type="checkbox" disabled value="True" />
                <label for="test-checkbox" class="disabled">label</label>
             </div>);
    }

    [Fact]
    public void BitCheckbox_Should_Render_Group_Correctly()
    {
        bool value = false;

        var component = Render(
            @<BitCheckbox Label="label"
                          Id="test-checkbox"
                          @bind-Value="value"
                          Grouped="true"/>);

        component.MarkupMatches(
            @<div class="form-check form-check-group">
                <input id="test-checkbox" name="test-checkbox" class="" type="checkbox" value="True" />
                <label for="test-checkbox" class="">label</label>
             </div>);
    }

    [Fact]
    public void BitCheckbox_Should_Render_Additional_Text_Correctly()
    {
        bool value = false;

        var component = Render(
            @<BitCheckbox Label="label"
                          Id="test-checkbox"
                          @bind-Value="value"
                          AdditionalTextId="helper-text">
                <AdditionalText>this is a help text</AdditionalText>
            </BitCheckbox>);

        component.MarkupMatches(
            @<div class="form-check">
                <input id="test-checkbox" name="test-checkbox" class="" type="checkbox" value="True" aria-describedby="helper-text" />
                <label for="test-checkbox" class="">label</label>
                <small id="helper-text" class="form-text">this is a help text</small>
             </div>);
    }

    [Fact]
    public void BitCheckbox_Should_Show_Invalid_Class_When_Field_Has_Validation_Error()
    {
        var model = new CheckboxValidationModel();
        var editContext = new EditContext(model);
        var submitted = false;

        var component = Render(
            @<EditForm EditContext="@editContext" OnValidSubmit="() => submitted = true">
                <DataAnnotationsValidator />
                <BitCheckbox Label="Accept Terms"
                             Id="test-accept"
                             @bind-Value="@model.AcceptTerms"
                             For="@(() => model.AcceptTerms)" />
                <button type="submit" id="submit-btn">Submit</button>
             </EditForm>);

        // Trigger validation by submitting the form
        var form = component.Find("form");
        form.Submit();

        var input = component.Find("input#test-accept");
        Assert.Contains("is-invalid", input.ClassList);
        Assert.DoesNotContain("just-validate-success-field", input.ClassList);
        Assert.False(submitted);
    }

    [Fact]
    public void BitCheckbox_Should_Show_Success_Class_When_Valid_Field_Is_Modified()
    {
        var model = new CheckboxValidationModel { AcceptTerms = true };
        var editContext = new EditContext(model);
        var submitted = false;

        var component = Render(
            @<EditForm EditContext="@editContext" OnValidSubmit="() => submitted = true">
                <DataAnnotationsValidator />
                <BitCheckbox Label="Accept Terms"
                             Id="test-accept"
                             @bind-Value="@model.AcceptTerms"
                             For="@(() => model.AcceptTerms)" />
                <button type="submit" id="submit-btn">Submit</button>
             </EditForm>);

        // Trigger validation by submitting the form
        var form = component.Find("form");
        form.Submit();

        var input = component.Find("input#test-accept");
        Assert.Contains("just-validate-success-field", input.ClassList);
        Assert.DoesNotContain("is-invalid", input.ClassList);
        Assert.True(submitted);
    }

    [Fact]
    public void BitCheckbox_Should_Render_Validation_Message_With_Correct_Class()
    {
        var model = new CheckboxValidationModel();
        var editContext = new EditContext(model);

        var component = Render(
            @<EditForm EditContext="@editContext" OnValidSubmit="() => {}">
                <DataAnnotationsValidator />
                <BitCheckbox Label="Accept Terms"
                             Id="test-accept"
                             @bind-Value="@model.AcceptTerms"
                             For="@(() => model.AcceptTerms)" />
                <button type="submit" id="submit-btn">Submit</button>
             </EditForm>);

        // Trigger validation by submitting the form
        var form = component.Find("form");
        form.Submit();

        var validationMessage = component.Find(".just-validate-error-label");
        Assert.NotNull(validationMessage);
        Assert.Contains("You must accept the terms", validationMessage.TextContent);
    }

    [Fact]
    public void BitCheckbox_Should_Not_Show_Validation_Classes_When_Field_Not_Modified()
    {
        var model = new CheckboxValidationModel();
        var editContext = new EditContext(model);

        var component = Render(
            @<EditForm EditContext="@editContext" OnValidSubmit="() => {}">
                <DataAnnotationsValidator />
                <BitCheckbox Label="Accept Terms"
                             Id="test-accept"
                             @bind-Value="@model.AcceptTerms"
                             For="@(() => model.AcceptTerms)" />
                <button type="submit" id="submit-btn">Submit</button>
             </EditForm>);

        // Do NOT submit the form - field is pristine
        var input = component.Find("input#test-accept");
        Assert.DoesNotContain("is-invalid", input.ClassList);
        Assert.DoesNotContain("just-validate-success-field", input.ClassList);
    }

    // Nested test model for validation tests
    public class CheckboxValidationModel
    {
        [Range(typeof(bool), "true", "true", ErrorMessage = "You must accept the terms")]
        public bool AcceptTerms { get; set; }
    }
}
